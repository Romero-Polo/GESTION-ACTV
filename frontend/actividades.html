<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Actividades - Gesti√≥n de Actividades</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background-color: #f9fafb;
            color: #374151;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem 0;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        h1 {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #4b5563;
        }

        .btn-success {
            background-color: #10b981;
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
        }

        main {
            padding: 2rem 0;
        }

        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .filters {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 2rem;
        }

        .filters-title {
            font-size: 1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 1rem;
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            align-items: end;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.25rem;
        }

        input, select {
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 0.875rem;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .activities-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            overflow: hidden;
        }

        .table-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .table-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #1f2937;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            text-align: left;
            font-size: 0.75rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
        }

        td {
            padding: 1rem;
            border-bottom: 1px solid #f3f4f6;
            font-size: 0.875rem;
        }

        tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .status-active {
            background: #ecfdf5;
            color: #047857;
        }

        .status-finished {
            background: #f3f4f6;
            color: #374151;
        }

        .resource-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            background: #f0f9ff;
            border-radius: 4px;
            font-size: 0.75rem;
        }

        .loading {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .loading-spinner {
            display: inline-block;
            width: 32px;
            height: 32px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1rem;
        }

        .alert-error {
            background-color: #fef2f2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .alert-info {
            background-color: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #dbeafe;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: center;
        }

        .btn-small {
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            border-radius: 4px;
        }

        .btn-edit {
            background-color: #f59e0b;
            color: white;
        }

        .btn-edit:hover {
            background-color: #d97706;
        }

        .btn-duplicate {
            background-color: #8b5cf6;
            color: white;
        }

        .btn-duplicate:hover {
            background-color: #7c3aed;
        }

        /* Modal styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #1f2937;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6b7280;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #1f2937;
        }

        .time-selector-container {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .time-select {
            width: auto;
            min-width: 60px;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            text-align: center;
        }

        .time-separator {
            font-weight: bold;
            color: #6b7280;
            font-size: 1.1rem;
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                justify-content: center;
            }

            .filters-row {
                grid-template-columns: 1fr;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            table {
                font-size: 0.75rem;
            }

            th, td {
                padding: 0.5rem;
            }
        }

        /* Toast Alert Styles */
        #alertContainer {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }

        .alert {
            padding: 16px 20px;
            margin-bottom: 10px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            animation: slideInRight 0.3s ease-out;
            position: relative;
        }

        .alert-info {
            background-color: #3b82f6;
            color: white;
            border: 1px solid #2563eb;
        }

        .alert-error {
            background-color: #ef4444;
            color: white;
            border: 1px solid #dc2626;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOutRight {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .alert.hiding {
            animation: slideOutRight 0.3s ease-in;
        }

        .version-link {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            background-color: #dbeafe;
            color: #1e40af;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
            transition: background-color 0.2s;
            margin-left: 12px;
        }

        .version-link:hover {
            background-color: #bfdbfe;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        /* Pagination Styles */
        .pagination-container {
            padding: 1rem 1.5rem;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .pagination-info {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .page-numbers {
            display: flex;
            gap: 0.25rem;
        }

        .page-number {
            padding: 0.375rem 0.75rem;
            border: 1px solid #d1d5db;
            background: white;
            color: #374151;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s;
            min-width: 32px;
            text-align: center;
        }

        .page-number:hover:not(.active) {
            background: #f3f4f6;
            border-color: #9ca3af;
        }

        .page-number.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .page-number.disabled {
            color: #d1d5db;
            cursor: not-allowed;
            background: #f9fafb;
        }

        @media (max-width: 768px) {
            .pagination-container {
                flex-direction: column;
                text-align: center;
            }

            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Alert Container -->
    <div id="alertContainer"></div>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <h1>üìä Lista de Actividades</h1>
                    <a href="changelog.html" class="version-link" title="Ver registro de cambios">
                        v1.6.1
                    </a>
                </div>
                <div class="header-actions">
                    <button class="btn btn-secondary" onclick="window.location.href='/index.html'">üè† Dashboard</button>
                    <a href="/nueva-actividad.html" class="btn btn-success">‚ûï Nueva Actividad</a>
                    <button onclick="loadActivities()" class="btn btn-primary" id="refreshBtn">
                        üîÑ Actualizar
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <!-- Estad√≠sticas -->
            <div class="stats-bar" id="statsBar">
                <div class="stat-card">
                    <div class="stat-value" id="totalActividades">-</div>
                    <div class="stat-label">Total Actividades</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="actividadesActivas">-</div>
                    <div class="stat-label">Jornadas Abiertas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="actividadesHoy">-</div>
                    <div class="stat-label">Hoy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="tiposUnicos">-</div>
                    <div class="stat-label">Tipos √önicos</div>
                </div>
            </div>

            <!-- Filtros -->
            <div class="filters">
                <div class="filters-title">üîç Filtros</div>
                <div class="filters-row">
                    <div class="form-group">
                        <label for="filterFecha">Fecha</label>
                        <input type="date" id="filterFecha" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="filterObra">Obra</label>
                        <select id="filterObra" onchange="applyFilters()">
                            <option value="">Todas las obras</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterRecurso">Recurso</label>
                        <select id="filterRecurso" onchange="applyFilters()">
                            <option value="">Todos los recursos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="filterTipo">Tipo</label>
                        <select id="filterTipo" onchange="applyFilters()">
                            <option value="">Todos los tipos</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <button onclick="clearFilters()" class="btn btn-secondary">Limpiar</button>
                    </div>
                </div>
            </div>


            <!-- Tabla de Actividades -->
            <div class="activities-table">
                <div class="table-header">
                    <div class="table-title">üìã Actividades Registradas</div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <div id="activityCount" style="font-size: 0.875rem; color: #6b7280;"></div>
                        <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; color: #6b7280;">
                            <span>Mostrar:</span>
                            <select id="pageSize" onchange="changePageSize()" style="padding: 0.25rem; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.75rem;">
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                            <span>por p√°gina</span>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Obra</th>
                                <th>Recurso</th>
                                <th>Tipo</th>
                                <th>Inicio</th>
                                <th>Fin</th>
                                <th>Estado</th>
                                <th>Observaciones</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="activitiesTableBody">
                            <tr>
                                <td colspan="9" class="loading">
                                    <div class="loading-spinner"></div>
                                    <div>Cargando actividades...</div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <!-- Controles de paginaci√≥n -->
                <div class="pagination-container" id="paginationContainer" style="display: none;">
                    <div class="pagination-info">
                        <span id="paginationInfo">Mostrando 1-25 de 100 actividades</span>
                    </div>
                    <div class="pagination-controls">
                        <button class="btn btn-small btn-secondary" id="prevPageBtn" onclick="goToPage(-1)" disabled>
                            ‚¨ÖÔ∏è Anterior
                        </button>
                        <div class="page-numbers" id="pageNumbers"></div>
                        <button class="btn btn-small btn-secondary" id="nextPageBtn" onclick="goToPage(1)">
                            Siguiente ‚û°Ô∏è
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal de Edici√≥n -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚úèÔ∏è Editar Actividad</div>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>

            <form id="editActivityForm">
                <input type="hidden" id="editActivityId">

                <!-- Informaci√≥n B√°sica -->
                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label for="editObra">Obra <span class="required">*</span></label>
                            <select id="editObra" name="obraId" required>
                                <option value="">Selecciona una obra...</option>
                            </select>
                        </div>
                        <div>
                            <label for="editRecurso">Recurso <span class="required">*</span></label>
                            <select id="editRecurso" name="recursoId" required>
                                <option value="">Selecciona un recurso...</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label for="editTipoActividad">Tipo de Actividad <span class="required">*</span></label>
                    <select id="editTipoActividad" name="tipoActividadId" required>
                        <option value="">Selecciona un tipo...</option>
                    </select>
                </div>

                <!-- Informaci√≥n Temporal -->
                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label for="editFechaInicio">Fecha de Inicio <span class="required">*</span></label>
                            <input type="date" id="editFechaInicio" name="fechaInicio" required>
                        </div>
                        <div>
                            <label for="editHoraInicio">Hora de Inicio <span class="required">*</span></label>
                            <div class="time-selector-container">
                                <select id="editHoraInicio_horas" class="time-select" required>
                                    <option value="">HH</option>
                                </select>
                                <span class="time-separator">:</span>
                                <select id="editHoraInicio_minutos" class="time-select" required>
                                    <option value="">MM</option>
                                    <option value="00" selected>00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <input type="hidden" id="editHoraInicio" name="horaInicio" required>
                            </div>
                            <div class="help-text">Solo se permiten intervalos de 15 minutos</div>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label for="editFechaFin">Fecha de Fin</label>
                            <input type="date" id="editFechaFin" name="fechaFin">
                        </div>
                        <div>
                            <label for="editHoraFin">Hora de Fin</label>
                            <div class="time-selector-container">
                                <select id="editHoraFin_horas" class="time-select">
                                    <option value="">HH</option>
                                </select>
                                <span class="time-separator">:</span>
                                <select id="editHoraFin_minutos" class="time-select">
                                    <option value="">MM</option>
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <input type="hidden" id="editHoraFin" name="horaFin">
                            </div>
                            <div class="help-text">Solo se permiten intervalos de 15 minutos</div>
                        </div>
                    </div>
                </div>

                <!-- Observaciones -->
                <div class="form-group">
                    <label for="editObservaciones">Observaciones</label>
                    <textarea id="editObservaciones" name="observaciones" placeholder="Detalles adicionales sobre la actividad (opcional)..."></textarea>
                </div>

                <!-- Acciones -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()">
                        ‚ùå Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeleteActivity()" id="deleteActivityBtn">
                        üóëÔ∏è Eliminar Actividad
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveEditBtn">
                        üíæ <u>G</u>uardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Duplicaci√≥n -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìã Duplicar Actividad</div>
                <button class="close-btn" onclick="closeDuplicateModal()">&times;</button>
            </div>

            <form id="duplicateActivityForm">
                <input type="hidden" id="originalActivityId">

                <!-- Informaci√≥n de la Actividad Original -->
                <div class="alert alert-info" style="margin-bottom: 1rem;">
                    <strong>Duplicando actividad:</strong>
                    <div id="originalActivityInfo"></div>
                </div>

                <!-- Selecci√≥n de Nuevo Recurso y Tipo de Actividad -->
                <div class="form-group">
                    <div class="form-row">
                        <div>
                            <label for="duplicateRecurso">Nuevo Recurso <span class="required">*</span></label>
                            <select id="duplicateRecurso" name="recursoId" required>
                                <option value="">Selecciona un recurso...</option>
                            </select>
                            <div class="help-text">Operario o m√°quina para la nueva actividad</div>
                        </div>
                        <div>
                            <label for="duplicateTipoActividad">Nuevo Tipo de Actividad <span class="required">*</span></label>
                            <select id="duplicateTipoActividad" name="tipoActividadId" required>
                                <option value="">Selecciona un tipo...</option>
                            </select>
                            <div class="help-text">Tipo de trabajo para la nueva actividad</div>
                        </div>
                    </div>
                </div>

                <!-- Informaci√≥n que se copiar√° autom√°ticamente -->
                <div class="form-group">
                    <div class="alert" style="background-color: #f0f9ff; border: 1px solid #dbeafe; color: #1e40af;">
                        <strong>Se copiar√° autom√°ticamente:</strong>
                        <ul style="margin: 0.5rem 0 0 1rem; padding: 0;">
                            <li>Obra</li>
                            <li>Fechas y horas</li>
                            <li>Observaciones</li>
                        </ul>
                    </div>
                </div>

                <!-- Acciones -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDuplicateModal()">
                        ‚ùå Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary" id="saveDuplicateBtn">
                        üìã Crear Duplicado
                    </button>
                </div>
            </form>
        </div>
    </div>

        <!-- Configuraci√≥n centralizada -->
    <script src="/config.js"></script>

    <script>
        // Configuraci√≥n
        // API_BASE se carga autom√°ticamente desde config.js
        let API_BASE = window.API_BASE || (window.appConfig?.getApiUrl('') || 'http://localhost:3002');

        // Estado de la aplicaci√≥n
        let allActivities = [];
        let filteredActivities = [];
        let filterData = {
            obras: [],
            recursos: [],
            tiposActividad: []
        };

        // Estado de paginaci√≥n
        let currentPage = 1;
        let pageSize = 25;
        let totalPages = 1;
        let paginatedActivities = [];

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeEditTimeSelectors();
            initializeDuplicateModal();
            loadActivities();
            loadFilterData();
        });

        // Inicializar selectores de tiempo para el modal de edici√≥n
        function initializeEditTimeSelectors() {
            // Poblar horas (00-23) para inicio y fin
            const horaInicioSelect = document.getElementById('editHoraInicio_horas');
            const horaFinSelect = document.getElementById('editHoraFin_horas');

            for (let i = 0; i < 24; i++) {
                const hora = i.toString().padStart(2, '0');

                const optionInicio = document.createElement('option');
                optionInicio.value = hora;
                optionInicio.textContent = hora;
                horaInicioSelect.appendChild(optionInicio);

                const optionFin = document.createElement('option');
                optionFin.value = hora;
                optionFin.textContent = hora;
                horaFinSelect.appendChild(optionFin);
            }

            // Agregar listeners para actualizar campos hidden
            ['editHoraInicio', 'editHoraFin'].forEach(fieldName => {
                const horasSelect = document.getElementById(fieldName + '_horas');
                const minutosSelect = document.getElementById(fieldName + '_minutos');

                function updateHiddenField() {
                    const horas = horasSelect.value;
                    const minutos = minutosSelect.value;
                    const hiddenField = document.getElementById(fieldName);

                    if (horas && minutos) {
                        hiddenField.value = horas + ':' + minutos;
                    } else {
                        hiddenField.value = '';
                    }
                }

                horasSelect.addEventListener('change', updateHiddenField);
                minutosSelect.addEventListener('change', updateHiddenField);
            });

            // Agregar listener especial para hora inicio que actualice las opciones de hora fin
            const editHoraInicioHoras = document.getElementById('editHoraInicio_horas');
            const editHoraInicioMinutos = document.getElementById('editHoraInicio_minutos');

            function updateEditEndTimeOptions() {
                const editHoraFinHoras = document.getElementById('editHoraFin_horas');
                const editHoraFinMinutos = document.getElementById('editHoraFin_minutos');

                const startHour = parseInt(editHoraInicioHoras.value);
                const startMinute = parseInt(editHoraInicioMinutos.value);

                if (isNaN(startHour) || isNaN(startMinute)) {
                    // Si no hay hora de inicio seleccionada, mostrar todas las opciones
                    return;
                }

                // Limpiar opciones actuales de hora fin
                editHoraFinHoras.innerHTML = '<option value="">HH</option>';

                // Agregar solo horas posteriores a la hora de inicio
                for (let i = startHour; i < 24; i++) {
                    const hora = i.toString().padStart(2, '0');
                    const option = document.createElement('option');
                    option.value = hora;
                    option.textContent = hora;
                    editHoraFinHoras.appendChild(option);
                }

                // Si es la misma hora, actualizar minutos para que sean posteriores
                updateEditEndMinuteOptions();
            }

            function updateEditEndMinuteOptions() {
                const editHoraFinHoras = document.getElementById('editHoraFin_horas');
                const editHoraFinMinutos = document.getElementById('editHoraFin_minutos');

                const startHour = parseInt(editHoraInicioHoras.value);
                const startMinute = parseInt(editHoraInicioMinutos.value);
                const endHour = parseInt(editHoraFinHoras.value);

                if (isNaN(startHour) || isNaN(startMinute) || isNaN(endHour)) {
                    return;
                }

                // Limpiar opciones de minutos
                editHoraFinMinutos.innerHTML = '<option value="">MM</option>';

                const validMinutes = ['00', '15', '30', '45'];

                if (endHour === startHour) {
                    // Misma hora: solo permitir minutos posteriores
                    validMinutes.forEach(minute => {
                        const minuteValue = parseInt(minute);
                        if (minuteValue > startMinute) {
                            const option = document.createElement('option');
                            option.value = minute;
                            option.textContent = minute;
                            editHoraFinMinutos.appendChild(option);
                        }
                    });
                } else {
                    // Hora diferente: permitir todos los minutos
                    validMinutes.forEach(minute => {
                        const option = document.createElement('option');
                        option.value = minute;
                        option.textContent = minute;
                        editHoraFinMinutos.appendChild(option);
                    });
                }
            }

            // Listeners para actualizar opciones de hora fin
            editHoraInicioHoras.addEventListener('change', updateEditEndTimeOptions);
            editHoraInicioMinutos.addEventListener('change', updateEditEndTimeOptions);
            document.getElementById('editHoraFin_horas').addEventListener('change', updateEditEndMinuteOptions);
        }

        // Funci√≥n para establecer tiempo en los selectores del modal
        function setEditTimeSelectors(fieldName, timeValue) {
            if (timeValue) {
                const [horas, minutos] = timeValue.split(':');
                document.getElementById(fieldName + '_horas').value = horas;
                document.getElementById(fieldName + '_minutos').value = minutos;
                document.getElementById(fieldName).value = timeValue;
            } else {
                document.getElementById(fieldName + '_horas').value = '';
                document.getElementById(fieldName + '_minutos').value = '';
                document.getElementById(fieldName).value = '';
            }
        }

        // Funci√≥n para normalizar formato de hora a HH:MM con minutos v√°lidos
        function normalizeTimeFormat(timeStr) {
            if (!timeStr) return null;

            // Limpiar la hora y extraer partes
            const cleanTime = timeStr.toString().trim();
            let [hours, minutes] = cleanTime.split(':');

            // Asegurar formato de 2 d√≠gitos para horas
            hours = hours.padStart(2, '0');

            // Redondear minutos a intervalos de 15
            const validMinutes = ['00', '15', '30', '45'];
            let minuteNum = parseInt(minutes || '0');

            // Encontrar el intervalo de 15 minutos m√°s cercano
            let closestMinute = validMinutes.reduce((prev, curr) => {
                return (Math.abs(curr - minuteNum) < Math.abs(prev - minuteNum) ? curr : prev);
            });

            return `${hours}:${closestMinute}`;
        }

        // Cargar actividades desde la API
        async function loadActivities() {
            try {
                showLoading();
                const refreshBtn = document.getElementById('refreshBtn');
                const originalText = refreshBtn.innerHTML;
                refreshBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Cargando...';
                refreshBtn.disabled = true;

                const response = await fetch(`${API_BASE}/actividades`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                allActivities = await response.json();
                filteredActivities = [...allActivities];

                console.log('‚úÖ Actividades cargadas:', allActivities.length);

                renderActivitiesTable();
                updateStatistics();

            } catch (error) {
                console.error('‚ùå Error loading activities:', error);
                showAlert('Error al cargar actividades: ' + error.message, 'error');
                showEmptyState('Error al cargar datos');
            } finally {
                const refreshBtn = document.getElementById('refreshBtn');
                refreshBtn.innerHTML = 'üîÑ Actualizar';
                refreshBtn.disabled = false;
            }
        }

        // Cargar datos para filtros
        async function loadFilterData() {
            try {
                const [obrasRes, recursosRes, tiposRes] = await Promise.all([
                    fetch(`${API_BASE}/obras`),
                    fetch(`${API_BASE}/recursos`),
                    fetch(`${API_BASE}/tipos-actividad`)
                ]);

                if (obrasRes.ok) {
                    filterData.obras = await obrasRes.json();
                    populateFilterSelect('filterObra', filterData.obras, 'codigo', 'descripcion');
                }

                if (recursosRes.ok) {
                    filterData.recursos = await recursosRes.json();
                    populateFilterSelect('filterRecurso', filterData.recursos, 'codigo', 'nombre');
                }

                if (tiposRes.ok) {
                    filterData.tiposActividad = await tiposRes.json();
                    populateFilterSelect('filterTipo', filterData.tiposActividad, 'codigo', 'nombre');
                }

            } catch (error) {
                console.error('Error loading filter data:', error);
            }
        }

        // Poblar select de filtros
        function populateFilterSelect(selectId, data, valueField, textField) {
            const select = document.getElementById(selectId);
            data.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = `${item[valueField]} - ${item[textField]}`;
                select.appendChild(option);
            });
        }

        // Renderizar tabla de actividades
        function renderActivitiesTable() {
            const tbody = document.getElementById('activitiesTableBody');
            const countElement = document.getElementById('activityCount');

            if (filteredActivities.length === 0) {
                showEmptyState();
                countElement.textContent = 'Sin actividades';
                hidePagination();
                return;
            }

            // Calcular paginaci√≥n
            updatePagination();

            // Obtener actividades para la p√°gina actual
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            paginatedActivities = filteredActivities.slice(startIndex, endIndex);

            // Actualizar contador
            const totalCount = filteredActivities.length;
            const showingStart = Math.min(startIndex + 1, totalCount);
            const showingEnd = Math.min(endIndex, totalCount);
            countElement.textContent = `${totalCount} actividad${totalCount !== 1 ? 'es' : ''} (${showingStart}-${showingEnd})`;

            tbody.innerHTML = paginatedActivities.map(activity => {
                const isActive = !activity.fechaFin && !activity.horaFin;
                const statusClass = isActive ? 'status-active' : 'status-finished';
                const statusText = isActive ? 'üü¢ Activa' : '‚ö´ Finalizada';

                const resourceIcon = activity.recurso?.tipo === 'operario' ? 'üë∑' : 'üöõ';

                return `
                    <tr>
                        <td>${formatDate(activity.fechaInicio)}</td>
                        <td>
                            <div style="font-weight: 500;">${activity.obra?.codigo || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">${activity.obra?.descripcion || ''}</div>
                        </td>
                        <td>
                            <div class="resource-badge">
                                ${resourceIcon} ${activity.recurso?.codigo || 'N/A'}
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem;">${activity.recurso?.nombre || ''}</div>
                        </td>
                        <td>
                            <div style="font-weight: 500;">${activity.tipoActividad?.codigo || 'N/A'}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">${activity.tipoActividad?.nombre || ''}</div>
                        </td>
                        <td>
                            <div>${activity.horaInicio || '-'}</div>
                        </td>
                        <td>
                            <div>${activity.horaFin || '-'}</div>
                        </td>
                        <td>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </td>
                        <td>
                            <div style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;" title="${activity.observaciones && activity.observaciones !== 'null' ? activity.observaciones : ''}">
                                ${activity.observaciones && activity.observaciones !== 'null' && activity.observaciones.trim() !== '' ? activity.observaciones : '-'}
                            </div>
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-small btn-edit" onclick="editActivity(${activity.id})" title="Editar actividad">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button class="btn btn-small btn-duplicate" onclick="duplicateActivity(${activity.id})" title="Duplicar actividad">
                                    üìã Duplicar
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Actualizar estad√≠sticas
        function updateStatistics() {
            const total = allActivities.length;
            const activas = allActivities.filter(a => !a.fechaFin && !a.horaFin).length;
            const hoy = allActivities.filter(a => {
                const today = new Date().toISOString().split('T')[0];
                return a.fechaInicio === today;
            }).length;
            const tiposUnicos = new Set(allActivities.map(a => a.tipoActividadId)).size;

            document.getElementById('totalActividades').textContent = total;
            document.getElementById('actividadesActivas').textContent = activas;
            document.getElementById('actividadesHoy').textContent = hoy;
            document.getElementById('tiposUnicos').textContent = tiposUnicos;
        }

        // Aplicar filtros
        function applyFilters() {
            const fechaFilter = document.getElementById('filterFecha').value;
            const obraFilter = document.getElementById('filterObra').value;
            const recursoFilter = document.getElementById('filterRecurso').value;
            const tipoFilter = document.getElementById('filterTipo').value;

            filteredActivities = allActivities.filter(activity => {
                if (fechaFilter && activity.fechaInicio !== fechaFilter) return false;
                if (obraFilter && activity.obraId != obraFilter) return false;
                if (recursoFilter && activity.recursoId != recursoFilter) return false;
                if (tipoFilter && activity.tipoActividadId != tipoFilter) return false;
                return true;
            });

            // Resetear p√°gina al aplicar filtros
            currentPage = 1;
            renderActivitiesTable();
        }

        // FUNCIONES DE PAGINACI√ìN

        // Cambiar tama√±o de p√°gina
        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSize').value);
            pageSize = newPageSize;
            currentPage = 1; // Resetear a primera p√°gina
            renderActivitiesTable();
        }

        // Actualizar paginaci√≥n
        function updatePagination() {
            totalPages = Math.ceil(filteredActivities.length / pageSize);

            // Mostrar/ocultar paginaci√≥n
            if (totalPages <= 1) {
                hidePagination();
            } else {
                showPagination();
            }
        }

        // Mostrar paginaci√≥n
        function showPagination() {
            const container = document.getElementById('paginationContainer');
            container.style.display = 'flex';

            updatePaginationInfo();
            updatePaginationControls();
        }

        // Ocultar paginaci√≥n
        function hidePagination() {
            const container = document.getElementById('paginationContainer');
            container.style.display = 'none';
        }

        // Actualizar informaci√≥n de paginaci√≥n
        function updatePaginationInfo() {
            const totalCount = filteredActivities.length;
            const startIndex = (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalCount);

            const info = document.getElementById('paginationInfo');
            info.textContent = `Mostrando ${startIndex}-${endIndex} de ${totalCount} actividades`;
        }

        // Actualizar controles de paginaci√≥n
        function updatePaginationControls() {
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const pageNumbers = document.getElementById('pageNumbers');

            // Botones anterior/siguiente
            prevBtn.disabled = currentPage <= 1;
            nextBtn.disabled = currentPage >= totalPages;

            // N√∫meros de p√°gina
            pageNumbers.innerHTML = generatePageNumbers();
        }

        // Generar n√∫meros de p√°gina
        function generatePageNumbers() {
            let html = '';
            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            // Ajustar startPage si estamos cerca del final
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            // Primera p√°gina si no est√° visible
            if (startPage > 1) {
                html += `<span class="page-number" onclick="goToPageNumber(1)">1</span>`;
                if (startPage > 2) {
                    html += `<span class="page-number disabled">...</span>`;
                }
            }

            // P√°ginas visibles
            for (let i = startPage; i <= endPage; i++) {
                const activeClass = i === currentPage ? ' active' : '';
                html += `<span class="page-number${activeClass}" onclick="goToPageNumber(${i})">${i}</span>`;
            }

            // √öltima p√°gina si no est√° visible
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span class="page-number disabled">...</span>`;
                }
                html += `<span class="page-number" onclick="goToPageNumber(${totalPages})">${totalPages}</span>`;
            }

            return html;
        }

        // Ir a p√°gina espec√≠fica
        function goToPageNumber(page) {
            if (page >= 1 && page <= totalPages && page !== currentPage) {
                currentPage = page;
                renderActivitiesTable();
            }
        }

        // Ir a p√°gina anterior/siguiente
        function goToPage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                renderActivitiesTable();
            }
        }

        // Limpiar filtros
        function clearFilters() {
            document.getElementById('filterFecha').value = '';
            document.getElementById('filterObra').value = '';
            document.getElementById('filterRecurso').value = '';
            document.getElementById('filterTipo').value = '';

            filteredActivities = [...allActivities];
            currentPage = 1; // Resetear p√°gina al limpiar filtros
            renderActivitiesTable();
        }

        // Formatear fecha
        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('es-ES', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Mostrar loading
        function showLoading() {
            const tbody = document.getElementById('activitiesTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="loading">
                        <div class="loading-spinner"></div>
                        <div>Cargando actividades...</div>
                    </td>
                </tr>
            `;
        }

        // Mostrar estado vac√≠o
        function showEmptyState(message = 'No se encontraron actividades') {
            const tbody = document.getElementById('activitiesTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="9" class="empty-state">
                        <div class="empty-state-icon">üìù</div>
                        <div style="font-size: 1.125rem; font-weight: 500; margin-bottom: 0.5rem;">${message}</div>
                        <div>Las actividades aparecer√°n aqu√≠ una vez que sean creadas.</div>
                        <div style="margin-top: 1rem;">
                            <a href="/nueva-actividad.html" class="btn btn-primary">‚ûï Crear Primera Actividad</a>
                        </div>
                    </td>
                </tr>
            `;
        }

        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alertClass = type === 'error' ? 'alert-error' : 'alert-info';

            const alertElement = document.createElement('div');
            alertElement.className = `alert ${alertClass}`;
            alertElement.innerHTML = message;

            container.appendChild(alertElement);

            // Auto-hide after 4 seconds
            setTimeout(() => {
                alertElement.classList.add('hiding');
                setTimeout(() => {
                    if (alertElement.parentNode) {
                        alertElement.parentNode.removeChild(alertElement);
                    }
                }, 300);
            }, 4000);
        }


        // FUNCIONES DE EDICI√ìN

        // Abrir modal de edici√≥n
        function editActivity(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) {
                showAlert('Actividad no encontrada', 'error');
                return;
            }

            // Poblar modal con datos de la actividad
            document.getElementById('editActivityId').value = activity.id;
            document.getElementById('editFechaInicio').value = activity.fechaInicio;
            setEditTimeSelectors('editHoraInicio', activity.horaInicio);
            document.getElementById('editFechaFin').value = activity.fechaFin || '';
            setEditTimeSelectors('editHoraFin', activity.horaFin || '');
            document.getElementById('editObservaciones').value = (activity.observaciones && activity.observaciones !== 'null') ? activity.observaciones : '';

            // Poblar selects del modal
            populateEditSelects(activity);

            // Mostrar modal
            document.getElementById('editModal').classList.add('active');
        }

        // Poblar selects del modal de edici√≥n
        function populateEditSelects(activity) {
            // Poblar obras
            const obraSelect = document.getElementById('editObra');
            obraSelect.innerHTML = '<option value="">Selecciona una obra...</option>';
            filterData.obras.forEach(obra => {
                const option = document.createElement('option');
                option.value = obra.id;
                option.textContent = `${obra.codigo} - ${obra.descripcion}`;
                if (obra.id === activity.obraId) option.selected = true;
                obraSelect.appendChild(option);
            });

            // Poblar recursos
            const recursoSelect = document.getElementById('editRecurso');
            recursoSelect.innerHTML = '<option value="">Selecciona un recurso...</option>';
            filterData.recursos.forEach(recurso => {
                const option = document.createElement('option');
                option.value = recurso.id;
                const tipoIcon = recurso.tipo === 'operario' ? 'üë∑' : 'üöõ';
                option.textContent = `${tipoIcon} ${recurso.codigo} - ${recurso.nombre}`;
                if (recurso.id === activity.recursoId) option.selected = true;
                recursoSelect.appendChild(option);
            });

            // Poblar tipos de actividad
            const tipoSelect = document.getElementById('editTipoActividad');
            tipoSelect.innerHTML = '<option value="">Selecciona un tipo...</option>';
            filterData.tiposActividad.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id;
                option.textContent = `${tipo.codigo} - ${tipo.nombre}`;
                if (tipo.id === activity.tipoActividadId) option.selected = true;
                tipoSelect.appendChild(option);
            });
        }

        // Cerrar modal de edici√≥n
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('active');
            document.getElementById('editActivityForm').reset();
        }

        // Manejar env√≠o del formulario de edici√≥n
        document.getElementById('editActivityForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const saveBtn = document.getElementById('saveEditBtn');
            const originalText = saveBtn.innerHTML;
            const activityId = document.getElementById('editActivityId').value;

            try {
                saveBtn.disabled = true;
                saveBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Guardando...';

                // Recoger datos del formulario
                const formData = new FormData(event.target);
                const activityData = Object.fromEntries(formData.entries());

                // Validaciones b√°sicas (reutilizando la funci√≥n de nueva actividad)
                if (!validateActivityData(activityData)) {
                    return;
                }

                // Enviar actualizaci√≥n a la API
                const response = await fetch(`${API_BASE}/actividades/${activityId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(activityData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                const result = await response.json();

                // Actualizar actividad en memoria local (optimizaci√≥n de rendimiento)
                const updatedActivity = {
                    ...result,
                    // Agregar datos calculados que necesita la tabla
                    obraNombre: allObras.find(o => o.id == result.obraId)?.descripcion || '',
                    recursoNombre: allRecursos.find(r => r.id == result.recursoId)?.nombre || '',
                    tipoNombre: allTiposActividad.find(t => t.id == result.tipoActividadId)?.nombre || '',
                    tipoColor: allTiposActividad.find(t => t.id == result.tipoActividadId)?.color || '#6b7280'
                };

                // Actualizar en allActivities
                const activityIndex = allActivities.findIndex(a => a.id == activityId);
                if (activityIndex !== -1) {
                    allActivities[activityIndex] = updatedActivity;
                }

                // Actualizar en filteredActivities si existe
                const filteredIndex = filteredActivities.findIndex(a => a.id == activityId);
                if (filteredIndex !== -1) {
                    filteredActivities[filteredIndex] = updatedActivity;
                }

                // Re-renderizar solo la tabla (mucho m√°s r√°pido que loadActivities completo)
                renderActivitiesTable();
                updateStatistics();

                // Mostrar √©xito
                showAlert('‚úÖ Actividad actualizada correctamente', 'success');

                // Cerrar modal
                closeEditModal();


            } catch (error) {
                showAlert('‚ùå Error al actualizar: ' + error.message, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = originalText;
            }
        });

        // Funci√≥n de validaci√≥n (reutilizada)
        function validateActivityData(data) {
            if (!data.obraId || !data.recursoId || !data.tipoActividadId) {
                showAlert('Por favor completa todos los campos obligatorios', 'error');
                return false;
            }

            if (!data.fechaInicio || !data.horaInicio) {
                showAlert('La fecha y hora de inicio son obligatorias', 'error');
                return false;
            }

            // Fecha y hora de inicio pueden ser futuras (planificaci√≥n de actividades)

            // Si hay fecha fin, validar que sea posterior al inicio
            if (data.fechaFin && data.horaFin) {
                const fechaFin = new Date(data.fechaFin + 'T' + data.horaFin);
                if (fechaFin <= fechaInicio) {
                    showAlert('La fecha y hora de fin deben ser posteriores al inicio', 'error');
                    return false;
                }
            }

            return true;
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('editModal').classList.contains('active')) {
                closeEditModal();
            }
            if (e.key === 'Escape' && document.getElementById('duplicateModal').classList.contains('active')) {
                closeDuplicateModal();
            }
        });

        // FUNCIONES DE DUPLICACI√ìN

        // Inicializar modal de duplicaci√≥n
        function initializeDuplicateModal() {
            // Manejar env√≠o del formulario de duplicaci√≥n
            document.getElementById('duplicateActivityForm').addEventListener('submit', async function(event) {
                event.preventDefault();

                const saveBtn = document.getElementById('saveDuplicateBtn');
                const originalText = saveBtn.innerHTML;
                const originalActivityId = document.getElementById('originalActivityId').value;

                try {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<div class="loading-spinner" style="width: 16px; height: 16px; border-width: 2px;"></div> Duplicando...';

                    // Obtener actividad original
                    const originalActivity = allActivities.find(a => a.id == originalActivityId);
                    if (!originalActivity) {
                        throw new Error('Actividad original no encontrada');
                    }

                    // Recoger nuevos datos del formulario
                    const formData = new FormData(event.target);
                    const newData = Object.fromEntries(formData.entries());

                    // Normalizar horas para asegurar formato correcto
                    const normalizedHoraInicio = normalizeTimeFormat(originalActivity.horaInicio);
                    const normalizedHoraFin = originalActivity.horaFin ? normalizeTimeFormat(originalActivity.horaFin) : null;

                    // Crear datos para la nueva actividad (copiando todo de la original excepto recurso y tipo)
                    const duplicateActivityData = {
                        obraId: originalActivity.obraId,
                        recursoId: parseInt(newData.recursoId),
                        tipoActividadId: parseInt(newData.tipoActividadId),
                        fechaInicio: originalActivity.fechaInicio,
                        horaInicio: normalizedHoraInicio,
                        observaciones: originalActivity.observaciones
                    };

                    // Solo incluir fechaFin y horaFin si tienen valores v√°lidos
                    if (originalActivity.fechaFin && originalActivity.fechaFin !== 'null') {
                        duplicateActivityData.fechaFin = originalActivity.fechaFin;
                    }
                    if (normalizedHoraFin && originalActivity.horaFin !== 'null') {
                        duplicateActivityData.horaFin = normalizedHoraFin;
                    }

                    // Validar datos b√°sicos
                    if (!duplicateActivityData.recursoId || !duplicateActivityData.tipoActividadId) {
                        showAlert('Por favor selecciona un recurso y tipo de actividad', 'error');
                        return;
                    }

                    // Validar que los datos obligatorios est√©n presentes
                    if (!duplicateActivityData.fechaInicio || !normalizedHoraInicio) {
                        showAlert('Error: La actividad original no tiene fecha/hora de inicio v√°lida', 'error');
                        return;
                    }

                    console.log('Datos a enviar para duplicaci√≥n:', duplicateActivityData);

                    // Enviar a la API
                    const response = await fetch(`${API_BASE}/actividades`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(duplicateActivityData)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();

                    // Mostrar √©xito
                    showAlert('‚úÖ Actividad duplicada correctamente', 'success');

                    // Cerrar modal y recargar datos
                    closeDuplicateModal();
                    await loadActivities();

    
                } catch (error) {
                    showAlert('‚ùå Error al duplicar: ' + error.message, 'error');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = originalText;
                }
            });

            // Cerrar modal al hacer clic fuera de √©l
            document.getElementById('duplicateModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDuplicateModal();
                }
            });
        }

        // Abrir modal de duplicaci√≥n
        function duplicateActivity(activityId) {
            const activity = allActivities.find(a => a.id === activityId);
            if (!activity) {
                showAlert('Actividad no encontrada', 'error');
                return;
            }

            // Guardar ID de actividad original
            document.getElementById('originalActivityId').value = activity.id;

            // Mostrar informaci√≥n de la actividad original
            const originalInfo = document.getElementById('originalActivityInfo');
            originalInfo.innerHTML = `
                <div style="font-size: 0.875rem; margin-top: 0.5rem;">
                    <strong>Obra:</strong> ${activity.obra?.codigo} - ${activity.obra?.descripcion}<br>
                    <strong>Recurso actual:</strong> ${activity.recurso?.codigo} - ${activity.recurso?.nombre}<br>
                    <strong>Tipo actual:</strong> ${activity.tipoActividad?.codigo} - ${activity.tipoActividad?.nombre}<br>
                    <strong>Fecha:</strong> ${activity.fechaInicio} ${activity.horaInicio}
                </div>
            `;

            // Poblar selectores de recurso y tipo de actividad
            populateDuplicateSelects(activity);

            // Mostrar modal
            document.getElementById('duplicateModal').classList.add('active');
        }

        // Poblar selectores del modal de duplicaci√≥n
        function populateDuplicateSelects(originalActivity) {
            // Poblar recursos
            const recursoSelect = document.getElementById('duplicateRecurso');
            recursoSelect.innerHTML = '<option value="">Selecciona un recurso...</option>';
            filterData.recursos.forEach(recurso => {
                const option = document.createElement('option');
                option.value = recurso.id;
                const tipoIcon = recurso.tipo === 'operario' ? 'üë∑' : 'üöõ';
                option.textContent = `${tipoIcon} ${recurso.codigo} - ${recurso.nombre}`;
                // Preseleccionar el recurso original
                if (recurso.id === originalActivity.recursoId) {
                    option.selected = true;
                }
                recursoSelect.appendChild(option);
            });

            // Poblar tipos de actividad
            const tipoSelect = document.getElementById('duplicateTipoActividad');
            tipoSelect.innerHTML = '<option value="">Selecciona un tipo...</option>';
            filterData.tiposActividad.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo.id;
                option.textContent = `${tipo.codigo} - ${tipo.nombre}`;
                // Preseleccionar el tipo de actividad original
                if (tipo.id === originalActivity.tipoActividadId) {
                    option.selected = true;
                }
                tipoSelect.appendChild(option);
            });
        }

        // Cerrar modal de duplicaci√≥n
        function closeDuplicateModal() {
            document.getElementById('duplicateModal').classList.remove('active');
            document.getElementById('duplicateActivityForm').reset();
        }

        // Confirmar eliminaci√≥n de actividad
        function confirmDeleteActivity() {
            const activityId = document.getElementById('editActivityId').value;

            // Buscar la actividad para mostrar informaci√≥n en la confirmaci√≥n
            const activity = allActivities.find(a => a.id == activityId);
            if (!activity) {
                showAlert('‚ùå Error: No se pudo encontrar la actividad', 'error');
                return;
            }

            // Construir mensaje de confirmaci√≥n con detalles de la actividad
            const obra = filterData.obras.find(o => o.id == activity.obraId);
            const recurso = filterData.recursos.find(r => r.id == activity.recursoId);
            const tipo = filterData.tiposActividad.find(t => t.id == activity.tipoActividadId);

            const confirmMessage = `¬øEst√°s seguro de que deseas ELIMINAR esta actividad?

üìã DETALLES DE LA ACTIVIDAD:
‚Ä¢ Obra: ${obra ? `${obra.codigo} - ${obra.descripcion}` : 'Sin asignar'}
‚Ä¢ Recurso: ${recurso ? `${recurso.nombre} (${recurso.codigo})` : 'Sin asignar'}
‚Ä¢ Tipo: ${tipo ? `${tipo.codigo} - ${tipo.nombre}` : 'Sin asignar'}
‚Ä¢ Fecha: ${activity.fechaInicio}
‚Ä¢ Hora: ${activity.horaInicio}${activity.horaFin ? ` - ${activity.horaFin}` : ''}

‚ö†Ô∏è ESTA ACCI√ìN NO SE PUEDE DESHACER ‚ö†Ô∏è`;

            if (confirm(confirmMessage)) {
                deleteActivity(activityId);
            }
        }

        // Eliminar actividad
        async function deleteActivity(activityId) {
            // Find the activity to delete for optimistic UI update
            const activityIndex = allActivities.findIndex(a => a.id == activityId);
            const activityToDelete = activityIndex !== -1 ? {...allActivities[activityIndex]} : null;

            // Immediate UI response - close modal and update UI optimistically
            closeEditModal();

            if (activityToDelete) {
                // Remove from local array immediately (optimistic update)
                allActivities.splice(activityIndex, 1);
                // Update table immediately
                displayActivities(allActivities);
                showAlert('‚úÖ Actividad eliminada - Procesando en segundo plano...', 'success');
            }

            try {
                console.log(`üóëÔ∏è Deleting activity: ${activityId}`);

                const response = await fetch(`${API_BASE}/actividades/${activityId}`, {
                    method: 'DELETE'
                });

                if (!response.ok) {
                    const result = await response.json().catch(() => ({}));
                    throw new Error(result.error || 'Error desconocido al eliminar');
                }

                // Confirmaci√≥n de que se elimin√≥ correctamente en servidor
                console.log('‚úÖ Activity deleted successfully on server');
                showAlert('‚úÖ Actividad eliminada correctamente', 'success');

                // Refrescar datos autom√°ticamente para asegurar sincronizaci√≥n
                try {
                    console.log('üîÑ Refrescando datos autom√°ticamente despu√©s de eliminar actividad...');
                    await loadActivities();
                    console.log('‚úÖ Datos actualizados autom√°ticamente');
                } catch (refreshError) {
                    console.error('‚ö†Ô∏è Error al refrescar datos autom√°ticamente:', refreshError);
                    showAlert('‚ö†Ô∏è La actividad se elimin√≥ pero no se pudo actualizar la vista autom√°ticamente. Recarga la p√°gina para ver los cambios.', 'warning');
                }

            } catch (error) {
                console.error('Delete operation failed:', error);

                // Rollback: restore the deleted activity
                if (activityToDelete) {
                    allActivities.splice(activityIndex, 0, activityToDelete);
                    displayActivities(allActivities); // Update UI to show restored activity
                }

                showAlert(`‚ùå Error al eliminar actividad: ${error.message}`, 'error');
            }
        }
    </script>

    
    <!-- Footer de informaci√≥n de conexi√≥n -->
    <footer style="position: fixed; bottom: 0; left: 0; right: 0; background-color: #1f2937; color: #9ca3af; padding: 8px 16px; font-size: 11px; border-top: 1px solid #374151; z-index: 1000;">
        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
            <div style="display: flex; gap: 15px; align-items: center;">
                <span>Frontend: http://localhost:5173</span>
                <span>Backend: <span id="apiBaseUrl">http://localhost:3002</span></span>
            </div>
            <div style="display: flex; gap: 15px; align-items: center;">
                <span>√öltima llamada: <span id="lastApiCall">Ninguna</span></span>
                <span id="apiStatus" style="padding: 2px 6px; border-radius: 3px; background-color: #374151;">Esperando...</span>
            </div>
        </div>
    </footer>

    <!-- Script para monitorear llamadas API -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Actualizar la URL del API en el footer
            const apiBaseElement = document.getElementById('apiBaseUrl');
            if (apiBaseElement && typeof API_BASE !== 'undefined') {
                apiBaseElement.textContent = API_BASE;
            }

            // Interceptar llamadas fetch para mostrar actividad de API
            const originalFetch = window.fetch;
            const lastApiCallElement = document.getElementById('lastApiCall');
            const apiStatusElement = document.getElementById('apiStatus');

            window.fetch = async function(...args) {
                const [url, options] = args;

                // Solo mostrar llamadas que vayan al API backend
                if (typeof url === 'string' && (url.includes('localhost:300') || url.includes(API_BASE))) {
                    const method = options?.method || 'GET';
                    const endpoint = url.replace(API_BASE, '').split('?')[0];

                    // Mostrar llamada en progreso
                    lastApiCallElement.textContent = `${method} ${endpoint}`;
                    apiStatusElement.textContent = 'Cargando...';
                    apiStatusElement.style.backgroundColor = '#f59e0b';

                    try {
                        const response = await originalFetch(...args);

                        // Mostrar resultado
                        const status = response.ok ? 'OK' : `Error ${response.status}`;
                        apiStatusElement.textContent = status;
                        apiStatusElement.style.backgroundColor = response.ok ? '#10b981' : '#ef4444';

                        // Resetear despu√©s de 2 segundos
                        setTimeout(() => {
                            if (apiStatusElement.textContent === status) {
                                apiStatusElement.textContent = 'Listo';
                                apiStatusElement.style.backgroundColor = '#374151';
                            }
                        }, 2000);

                        return response;
                    } catch (error) {
                        apiStatusElement.textContent = 'Error de red';
                        apiStatusElement.style.backgroundColor = '#ef4444';
                        setTimeout(() => {
                            apiStatusElement.textContent = 'Error';
                            apiStatusElement.style.backgroundColor = '#374151';
                        }, 3000);
                        throw error;
                    }
                }

                return originalFetch(...args);
            };
        });
    </script>
</body>
</html>
